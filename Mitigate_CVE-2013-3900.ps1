#Requires -RunAsAdministrator

$ErrorActionPreference = "Stop"

try {
    $is64bitOS = [Environment]::Is64BitOperatingSystem

    # Create primary registry path if missing
    $primaryPath = "HKLM:\Software\Microsoft\Cryptography\Wintrust\Config"
    if (-not (Test-Path $primaryPath)) {
        New-Item -Path $primaryPath -Force | Out-Null
        Write-Host "Created primary registry path"
    }
    New-ItemProperty -Path $primaryPath -Name "EnableCertPaddingCheck" -Value 1 -PropertyType DWORD -Force | Out-Null
    Write-Host "Successfully configured primary registry key"

    # Create/configure Wow6432Node path on 64-bit systems
    if ($is64bitOS) {
        $wowPath = "HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config"
        if (-not (Test-Path $wowPath)) {
            New-Item -Path $wowPath -Force | Out-Null
            Write-Host "Created Wow6432Node registry path"
        }
        New-ItemProperty -Path $wowPath -Name "EnableCertPaddingCheck" -Value 1 -PropertyType DWORD -Force | Out-Null
        Write-Host "Successfully configured Wow6432Node registry key"
    }
    
    Write-Host "`nMitigation applied successfully. Please reboot the system for changes to take effect."
    Write-Host "Registry keys modified:"
    Write-Host " - HKLM:\Software\Microsoft\Cryptography\Wintrust\Config\EnableCertPaddingCheck = 1"
    if ($is64bitOS) {
        Write-Host " - HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config\EnableCertPaddingCheck = 1"
    }
}
catch {
    Write-Host "`nError occurred: $_" -ForegroundColor Red
    Write-Host "Mitigation may not have been fully applied. Please check registry keys manually."
    exit 1
}