#Requires -RunAsAdministrator

$ErrorActionPreference = "Stop"

try {
    Write-Host "--- Checking current configuration... ---" -ForegroundColor Cyan
    $is64bitOS = [Environment]::Is64BitOperatingSystem
    $primaryPath = "HKLM:\Software\Microsoft\Cryptography\Wintrust\Config"
    $wowPath = "HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config"
    
    $isCompliant = $true

    # Check primary path
    $primaryValue = Get-ItemProperty -Path $primaryPath -Name "EnableCertPaddingCheck" -ErrorAction SilentlyContinue
    if (($null -eq $primaryValue) -or ($primaryValue.EnableCertPaddingCheck -ne 1)) {
        $isCompliant = $false
        Write-Host "Primary registry setting is not compliant." -ForegroundColor Yellow
    }

    # Check Wow6432Node path on 64-bit systems
    if ($is64bitOS) {
        $wowValue = Get-ItemProperty -Path $wowPath -Name "EnableCertPaddingCheck" -ErrorAction SilentlyContinue
        if (($null -eq $wowValue) -or ($wowValue.EnableCertPaddingCheck -ne 1)) {
            $isCompliant = $false
            Write-Host "Wow6432Node registry setting is not compliant." -ForegroundColor Yellow
        }
    }

    # If already compliant, report and exit.
    if ($isCompliant) {
        Write-Host "\nSUCCESS: Mitigation is already applied. No action needed." -ForegroundColor Green
    } else {
        # --- FIX SECTION ---
        Write-Host "\n--- Applying Fix ---" -ForegroundColor Cyan

        # Configure primary registry key
        if (-not (Test-Path $primaryPath)) {
            New-Item -Path $primaryPath -Force | Out-Null
        }
        New-ItemProperty -Path $primaryPath -Name "EnableCertPaddingCheck" -Value 1 -PropertyType DWORD -Force | Out-Null
        Write-Host "Successfully configured primary registry key."

        # Configure Wow6432Node path on 64-bit systems
        if ($is64bitOS) {
            if (-not (Test-Path $wowPath)) {
                New-Item -Path $wowPath -Force | Out-Null
            }
            New-ItemProperty -Path $wowPath -Name "EnableCertPaddingCheck" -Value 1 -PropertyType DWORD -Force | Out-Null
            Write-Host "Successfully configured Wow6432Node registry key."
        }
        
        Write-Host "\nMitigation applied successfully."
    }

    # --- FINAL VALIDATION SECTION ---
    Write-Host "\n--- Current Settings ---" -ForegroundColor Cyan
    
    # Show primary path value
    Get-ItemProperty $primaryPath | Select-Object EnableCertPaddingCheck
    
    # Show Wow6432Node path value on 64-bit systems
    if ($is64bitOS) {
        Get-ItemProperty $wowPath | Select-Object EnableCertPaddingCheck
    }

    Write-Host "\nOperation complete. A reboot is required for changes to take full effect if a fix was applied." -ForegroundColor Green
}
catch {
    Write-Host "\nError occurred: $_" -ForegroundColor Red
    Write-Host "Operation failed. Please check registry keys manually."
    exit 1
}
